name: Build and Push to Docker Hub

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ·»åŠ æ‰‹åŠ¨è§¦å‘
    inputs:
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•ï¼Ÿ'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: docker.io
  IMAGE_NAME: amap_proxy

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:buildx-stable-1

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push multi-arch images
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:amd64
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: type=registry

    - name: Verify multi-arch manifests
      if: github.event_name != 'pull_request'
      run: |
        echo "ğŸ” éªŒè¯å¤šæ¶æ„é•œåƒæ¸…å•..."
        
        # å®‰è£… jq ç”¨äº JSON è§£æ
        sudo apt-get update && sudo apt-get install -y jq
        
        # éªŒè¯ latest æ ‡ç­¾ï¼ˆåº”è¯¥æ˜¯å¤šæ¶æ„ï¼‰
        echo "=== latest æ ‡ç­¾ ==="
        docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest || echo "latest æ ‡ç­¾éªŒè¯å¤±è´¥"
        
        echo "=== amd64 æ ‡ç­¾ ==="
        docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:amd64 || echo "amd64 æ ‡ç­¾éªŒè¯å¤±è´¥"
        
        echo "=== arm64 æ ‡ç­¾ ==="  
        docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:arm64 || echo "arm64 æ ‡ç­¾éªŒè¯å¤±è´¥"

    - name: Show build summary
      run: |
        echo "ğŸ‰ é•œåƒæ„å»ºå’Œæ¨é€å®Œæˆï¼"
        echo ""
        echo "ğŸ“¦ é•œåƒä¿¡æ¯:"
        echo "   ä»“åº“: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
        echo "   è§¦å‘: ${{ github.event_name }}"
        echo "   æäº¤: ${{ github.sha }}"
        echo ""
        echo "ğŸ·ï¸ å¯ç”¨æ ‡ç­¾:"
        echo "   â€¢ latest    - å¤šæ¶æ„é•œåƒï¼ˆè‡ªåŠ¨é€‰æ‹©ï¼‰"
        echo "   â€¢ amd64     - x86/64 æ¶æ„ä¸“ç”¨"
        echo "   â€¢ arm64     - ARM æ¶æ„ä¸“ç”¨"
        echo ""
        echo "ğŸš€ ä½¿ç”¨å‘½ä»¤:"
        echo "   # è‡ªåŠ¨é€‰æ‹©æ¶æ„ï¼ˆæ¨èï¼‰"
        echo "   docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo ""
        echo "   # æ‰‹åŠ¨é€‰æ‹©æ¶æ„"
        echo "   docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:amd64    # x86æœåŠ¡å™¨"
        echo "   docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:arm64    # ARMæœåŠ¡å™¨"
        echo ""
        echo "   # è¿è¡Œå®¹å™¨"
        echo "   docker run -d -p 8280:8280 ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"

  test-images:
    needs: build-and-push
    if: github.event_name != 'pull_request' && !inputs.skip_tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
    - name: Test ${{ matrix.arch }} image
      run: |
        echo "ğŸ§ª æµ‹è¯• ${{ matrix.arch }} æ¶æ„é•œåƒ..."
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ matrix.arch }}
        
        # è¿è¡Œå¥åº·æ£€æŸ¥æµ‹è¯•
        docker run -d --name test-${{ matrix.arch }} \
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ matrix.arch }}
        
        sleep 10
        
        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        if docker ps | grep -q "test-${{ matrix.arch }}"; then
          echo "âœ… ${{ matrix.arch }} é•œåƒæµ‹è¯•é€šè¿‡"
          docker stop test-${{ matrix.arch }}
          docker rm test-${{ matrix.arch }}
        else
          echo "âŒ ${{ matrix.arch }} é•œåƒæµ‹è¯•å¤±è´¥"
          docker logs test-${{ matrix.arch }}
          exit 1
        fi